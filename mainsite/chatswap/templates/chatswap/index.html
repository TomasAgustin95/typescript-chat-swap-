
<!DOCTYPE html>
<html lang="en">
{% load static %}
{% load zrxrequests %}
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Swap Demo Tutorial</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'chatswap/style.css' %}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">My DEX Aggregator</a>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <button id="login_button" class="btn btn-outline-primary my-2 my-sm-0" type="submit">Sign in with MetaMask</button>
          </li>
      </nav>
      <div class ="container">
        <div class="row">
            <div class="col col-md-6 offset-md-3" id="window">
                <h4>Swap</h4>
                <div id="form">
                    <div class="swapbox">
                        <div class="swapbox_select token_select" id = "sell_token">
                            SELECT A TOKEN
                        </div>
                        <div class="swapbox_select">
                            <input class="number form-control" placeholder="amount" id = "sell_amount" onchange = "getPrice('sell')">
                        </div>
                    </div>
                    <div class="swapbox">
                        <div class="swapbox_select token_select" id = "buy_token">
                            SELECT A TOKEN
                        </div>
                         <div class="swapbox_select">
                            <input class="number form-control" placeholder="amount" id="buy_amount" onchange = "getPrice('buy')">
                        </div>
                    </div>  
                    <div class="gas_estimate_label">Estimated Gas: <span id="gas_estimate"></span></div>
                    <button class="btn btn-large btn-primary btn-block" id="swap_button">Swap</button>                
                </div>
            </div>
        </div>
    </div>
    <div class="modal" tabindex="-1" role="dialog" id = "token_modal">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Tokens: </h5>
              <button type="button" id = "modal_close" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                {% for i in tokenData %}
                <div class="individ_token_select" id = "token_{{i.ticker}}"> {% comment %} Will need to put an id parameter that is generated to be unique by the for loop tag with another template tag/variable {% endcomment %}
                {{i.ticker}} 
                </div>
                {% endfor %} 
          </div>
        </div>
    </div>
</body>
</html>
{% comment %} {% load static %}
    <script src="{% static 'chatswap/index.js' %}" type="text/javascript"></script> {% endcomment %}

<script>
console.log(window.ethereum);
let accountPromise;
let sellModalOpen = false;
let buyModalOpen = false;
let buytoken;
let sellToken;
let priceData;
let buyAmount = false;
let buyDecimals;
let sellDecimals;

function getAccount() {
    return ethereum.request({ method: 'eth_requestAccounts'});
}

document.getElementById("login_button").onclick = function(){
    accountPromise = getAccount().then(accounts => {
        return accounts[0];
    })
};

console.log("{{tokenNames.0}}"); //testing template tags in js

function getModal() {
  document.getElementById("token_modal").style.display = "block";
}
function closeModal() {
  document.getElementById("token_modal").style.display = "none";
}
document.getElementById("buy_token").onclick = function(){
  getModal()
  buyModalOpen = true;
  sellModalOpen = false;
  console.log("buy modal");
};
document.getElementById("sell_token").onclick = function(){
  getModal()
  sellModalOpen = true;
  buyModalOpen = false;
  console.log("sell modal");
  };
document.getElementById("modal_close").onclick = function(){closeModal()};

{% for i in tokenData %}
document.getElementById("token_{{i.ticker}}").onclick = function() {
    if (buyModalOpen == true) {
        document.getElementById("buy_token").innerHTML = "{{i.ticker}}";
        buyToken = "{{ i.contract }}";
        buyDecimals = "{{ i.decimals }}";
        console.log(buyDecimals);
        console.log(buyToken);
        closeModal();
        //getPrice();
    }
    if (sellModalOpen == true) {
        document.getElementById("sell_token").innerHTML = "{{i.ticker}}";
        sellToken = "{{ i.contract }}";
        sellDecimals = "{{ i.decimals }}";
        console.log(sellDecimals);
        console.log(sellToken);
        closeModal();
        //getPrice();
    }
}
{% endfor %}
function getPrice(buyOrSell) {
    if (buyToken != null && sellToken != null) {
        const Http = new XMLHttpRequest();
        const url= "https://api.0x.org/swap/v1/price/";
        const params = "buyToken=" + buyToken + "&sellToken=" + sellToken + "&" + buyOrSell;
        
            //console.log(Http.responseText["price"]);
            if (buyOrSell == "sell") {
                Http.open("GET", url + "?" + params + "Amount=" + 10 ** (sellDecimals));
                Http.send();
                Http.onreadystatechange = (e) => {
                    let responseDict = JSON.parse(Http.responseText);
                    amount = document.getElementById("sell_amount").value;
                    document.getElementById("buy_amount").placeholder = null;
                    document.getElementById("buy_amount").value = responseDict["price"] * amount;
                    document.getElementById("sell_amount").placeholder = "";
                }
            }
            if (buyOrSell == "buy") {
                Http.open("GET", url + "?" + params + "Amount=" + 10 ** (buyDecimals));
                Http.send();
                Http.onreadystatechange = (e) => {
                    let responseDict = JSON.parse(Http.responseText);
                    amount = document.getElementById("buy_amount").value;
                    document.getElementById("sell_amount").placeholder = null;
                    console.log(document.getElementById("sell_amount").value);
                    document.getElementById("sell_amount").value = responseDict["price"] * amount;
                    document.getElementById("buy_amount").placeholder = "";
                }
            }
    }
}
async function getQuote() {
    if (buyToken != null && sellToken != null) {
        const account = await accountPromise;
        console.log(account); //testing getAccount()
        let responseDict;
        let amount;
        if (document.getElementById("sell_amount").value >= 1) {
            amount = document.getElementById("sell_amount").value * (10 ** sellDecimals) / 10;
        }
        else {
            amount = document.getElementById("sell_amount").value * (10 ** sellDecimals);
        }
        console.log(amount);
        const Http = new XMLHttpRequest();
        const url= "https://api.0x.org/swap/v1/quote/";
        const params = "buyToken=" + buyToken + "&sellToken=" + sellToken + "&sellAmount=" +  amount + "&takerAddress=" + account;
        console.log(sellDecimals);
        Http.open("GET", url + "?" + params);
        Http.send();
        return Http;
    }
}

function countDigits(number) {
    let s = number.toString();
    let count = 0;
    for (i = 0; i < s.length; i++) {
        if (s.charAt(i) != '.') {
            count++;
        }
        else {
            break;
        }
    }
    return count;
} 

document.getElementById("swap_button").onclick = function() { //Test for getQuote(), although the same functionality with this button will be implemented
    accountPromise = getAccount().then(accounts => {
        return accounts[0];
    })
    quoteTest = getQuote(); //test for returning json response.
    quoteTest.onreadystatechange = (e) => {
        responseDict = JSON.parse(quoteTest.responseText);
        console.log(responseDict);
    }
}
    //Need to figure out how to return a value for how many digits the "sell amount" value is when inputed and then
    //subtract that amount from the sellDecimals variable when passing it to the swap quote URL. I believe this has something
    // to do with getPrice caculations. When putting in different amounts of tokens, it seems the amount can get to a decimal way more precise
    // than the tokens actual decimal precision. Because this value is calculated using basic multiplacation and then passed from the
    // getPrice method to the input blocks and then the input block's value is then passed to the getQuote function, the decimal precision is not
    // taken into consideration and results in a number with far more digits. I should try to reimplement the getPrice function to fill in the
    // token amount values directly from the 0x price API endpoint by inputting the amount typed in a input block directly into the get request.
    //Also, for tokens with over 21 decimals, javascript is going to put the amount into scientific notation.
    //So I need to find a way to ensure those sell amounts are in decimal format only.

</script>